{% extends "base.html" %}

{% block content %}
<div class="admin-container">
    <header class="admin-header">
        <h1>Dashboard</h1>
        <div class="header-actions">
            <form id="deploy-form" action="/admin/deploy" method="POST">
                <button type="submit" class="btn btn-primary">Deploy Live</button>
            </form>
            <a href="/admin/logout" class="btn">Logout</a>
        </div>
    </header>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('deploy') === 'success') {
            document.addEventListener('DOMContentLoaded', () => {
                window.showAlert('Success', 'Deployment triggered successfully!');
            });
            // clear param
            window.history.replaceState({}, document.title, window.location.pathname);
        }

        // Handle Deploy Confirmation
        document.addEventListener('DOMContentLoaded', () => {
            const deployForm = document.getElementById('deploy-form');
            if (deployForm) {
                deployForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    window.showConfirm(
                        'Deploy Live?',
                        'This will trigger a GitHub Action to build and deploy your static site. It may take a few minutes.',
                        () => deployForm.submit(),
                        'Deploy'
                    );
                });
            }
        });
    </script>


    <div class="admin-grid">
        <aside class="admin-sidebar">
            <nav>
                <a href="/admin/dashboard" class="nav-link active">Projects</a>
                <a href="/admin/pages" class="nav-link">Pages</a>
                <a href="/admin/settings" class="nav-link">Settings</a>
            </nav>
        </aside>

        <section class="admin-content">
            <div class="admin-content-header">
                <h2>All Projects</h2>
                <a href="/admin/projects/new" class="btn">
                    + New Project
                </a>
            </div>

            <div class="projects-list">
                {% for project in projects %}
                <div class="project-item">
                    <div class="item-info">
                        <h3>{{ project.title }}</h3>
                        <span class="item-meta">{{ project.start_date.year() }}</span>
                    </div>
                    <div class="item-actions">
                        <a href="/project/{{ project.slug }}" target="_blank" title="View" class="icon-btn">
                            <span class="material-icons">visibility</span>
                        </a>
                        <a href="/admin/projects/{{ project.id }}/blocks" class="button">Blocks</a>
                        <a href="/admin/projects/edit/{{ project.id }}" class="button">Edit</a>
                        <form action="/admin/projects/delete/{{ project.id }}" method="POST"
                            class="confirm-delete inline-form">
                            <button type="submit" class="icon-btn delete">
                                <span class="material-icons">delete</span>
                            </button>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
    </div>
</div>
{% endblock %}